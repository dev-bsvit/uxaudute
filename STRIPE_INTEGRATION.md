# üí≥ Stripe –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –¥–ª—è —Ç–æ–∫–µ–Ω–æ–º–∏–∫–∏

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ —Ç–æ–∫–µ–Ω–æ–º–∏–∫–∏ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å–æ Stripe –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ –∫—Ä–µ–¥–∏—Ç—ã.

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. API Endpoints

- **`/api/stripe/create-payment-intent`** - –°–æ–∑–¥–∞–Ω–∏–µ Payment Intent
- **`/api/stripe/webhook`** - –û–±—Ä–∞–±–æ—Ç–∫–∞ webhook –æ—Ç Stripe

### 2. –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI

- **`CreditsPurchase`** - –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–æ–∫—É–ø–∫–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤
- **`StripeCheckout`** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç Stripe Checkout

### 3. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏

- **`/lib/stripe.ts`** - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ —É—Ç–∏–ª–∏—Ç—ã Stripe

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (Production)

```bash
# Stripe (Production)
STRIPE_SECRET_KEY=sk_live_...
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# App (Production)
NEXT_PUBLIC_APP_URL=https://yourdomain.com
```

### 2. Webhook –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (Production)

1. –í Stripe Dashboard —Å–æ–∑–¥–∞–π—Ç–µ webhook endpoint:
   - URL: `https://yourdomain.com/api/stripe/webhook`
   - Events: `payment_intent.succeeded`, `payment_intent.payment_failed`, `payment_intent.canceled`

2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ webhook secret –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é `STRIPE_WEBHOOK_SECRET`

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Vercel

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
2. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
   - `STRIPE_SECRET_KEY` (Production)
   - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` (Production)
   - `STRIPE_WEBHOOK_SECRET` (Production)
   - `NEXT_PUBLIC_APP_URL` (Production)

## –ü–æ—Ç–æ–∫ –ø–ª–∞—Ç–µ–∂–∞

### 1. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞
```typescript
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø–∞–∫–µ—Ç
const response = await fetch('/api/stripe/create-payment-intent', {
  method: 'POST',
  body: JSON.stringify({
    package_id: 'basic',
    package_type: 'basic',
    credits_amount: 20,
    price_rub: 2000
  })
})
```

### 2. Payment Intent
```typescript
// –°–æ–∑–¥–∞–µ—Ç—Å—è Payment Intent –≤ Stripe
const paymentIntent = await stripe.paymentIntents.create({
  amount: 200000, // 2000 —Ä—É–±–ª–µ–π –≤ –∫–æ–ø–µ–π–∫–∞—Ö
  currency: 'rub',
  metadata: {
    user_id: 'user-uuid',
    order_id: 'order-uuid',
    package_type: 'basic',
    credits_amount: '20'
  }
})
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞
```typescript
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
const { error, paymentIntent } = await stripe.confirmPayment({
  elements,
  confirmParams: {
    return_url: 'https://yourdomain.com/credits?success=true'
  }
})
```

### 4. Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞
```typescript
// –ü—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ webhook:
// 1. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ 'paid'
// 2. –î–æ–±–∞–≤–ª—è–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
// 3. –°–æ–∑–¥–∞–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
```

## –ü–∞–∫–µ—Ç—ã –∫—Ä–µ–¥–∏—Ç–æ–≤

| –ü–∞–∫–µ—Ç | –ö—Ä–µ–¥–∏—Ç—ã | –¶–µ–Ω–∞ | –¶–µ–Ω–∞ –∑–∞ –∫—Ä–µ–¥–∏—Ç |
|-------|---------|------|----------------|
| Basic | 20      | 2000‚ÇΩ | 100‚ÇΩ |
| Pro   | 60      | 5000‚ÇΩ | 83‚ÇΩ |
| Team  | 200     | 15000‚ÇΩ | 75‚ÇΩ |

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### 1. Webhook –ø—Ä–æ–≤–µ—Ä–∫–∞
- –í—Å–µ webhook –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ –ø–æ–¥–ø–∏—Å–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `STRIPE_WEBHOOK_SECRET`

### 2. –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- Payment Intent —Å–æ–¥–µ—Ä–∂–∏—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–≤—è–∑–∏ —Å –∑–∞–∫–∞–∑–æ–º
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

### 3. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ webhook –Ω–µ —Å–æ–∑–¥–∞—é—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–µ –∫—Ä–µ–¥–∏—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `stripe_payment_intent_id` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã Stripe
```
–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂: 4242 4242 4242 4242
–ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: 4000 0000 0000 0002
–¢—Ä–µ–±—É–µ—Ç 3D Secure: 4000 0025 0000 3155
```

### 2. –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `sk_test_` –∏ `pk_test_` –∫–ª—é—á–∏
- –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –≤ —Ç–µ—Å—Ç–æ–≤–æ–º —Ä–µ–∂–∏–º–µ

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### 1. –õ–æ–≥–∏
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
- –û—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö

### 2. –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤
- `pending` - –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω
- `payment_pending` - –û–∂–∏–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂
- `paid` - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω
- `failed` - –ü–ª–∞—Ç–µ–∂ –Ω–µ—É–¥–∞—á–µ–Ω
- `canceled` - –ü–ª–∞—Ç–µ–∂ –æ—Ç–º–µ–Ω–µ–Ω

## Troubleshooting

### 1. Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook –≤ Stripe Dashboard
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ `STRIPE_WEBHOOK_SECRET` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

### 2. Payment Intent –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `STRIPE_SECRET_KEY`
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—É–º–º–∞ –≤ –∫–æ–ø–µ–π–∫–∞—Ö (—Ä—É–±–ª–∏ * 100)

### 3. –ö—Ä–µ–¥–∏—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –æ–±—Ä–∞–±–æ—Ç–∫—É
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **Production –Ω–∞—Å—Ç—Ä–æ–π–∫–∞** - –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ live –∫–ª—é—á–∏ Stripe
2. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ –∏ –º–µ—Ç—Ä–∏–∫
3. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –û—Ç—á–µ—Ç—ã –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º –∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏
4. **–í–æ–∑–≤—Ä–∞—Ç—ã** - –û–±—Ä–∞–±–æ—Ç–∫–∞ refunds –∏ chargebacks
