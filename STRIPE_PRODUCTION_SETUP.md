# üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Stripe –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π Stripe (Production)

1. **–í–æ–π–¥–∏—Ç–µ –≤ Stripe Dashboard**: https://dashboard.stripe.com/
2. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ Live —Ä–µ–∂–∏–º** (–≤–∫–ª—é—á–∏—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É)
3. **–ü–æ–ª—É—á–∏—Ç–µ –∫–ª—é—á–∏**:
   - `STRIPE_SECRET_KEY` = `sk_live_...` (–∏–∑ Developers ‚Üí API keys)
   - `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` = `pk_live_...` (–∏–∑ Developers ‚Üí API keys)

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhook –≤ Stripe

1. **–°–æ–∑–¥–∞–π—Ç–µ Webhook Endpoint**:
   - URL: `https://yourdomain.com/api/stripe/webhook`
   - Events: `payment_intent.succeeded`, `payment_intent.payment_failed`, `payment_intent.canceled`

2. **–ü–æ–ª—É—á–∏—Ç–µ Webhook Secret**:
   - –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `whsec_...` –∏–∑ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ webhook
   - –≠—Ç–æ –±—É–¥–µ—Ç `STRIPE_WEBHOOK_SECRET`

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ Vercel

1. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Vercel Dashboard** ‚Üí –í–∞—à –ø—Ä–æ–µ–∫—Ç ‚Üí Settings ‚Üí Environment Variables

2. **–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** (Production):
   ```
   STRIPE_SECRET_KEY=sk_live_...
   NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_live_...
   STRIPE_WEBHOOK_SECRET=whsec_...
   NEXT_PUBLIC_APP_URL=https://yourdomain.com
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–µ–ø–ª–æ–π**:
   - Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook**:
   ```bash
   curl -X POST https://yourdomain.com/api/stripe/webhook \
     -H "Content-Type: application/json" \
     -d '{"test": "webhook"}'
   ```

2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Payment Intent**:
   ```bash
   curl -X POST https://yourdomain.com/api/stripe/create-payment-intent \
     -H "Content-Type: application/json" \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -d '{"package_type": "basic", "credits_amount": 20, "price_rub": 2000}'
   ```

### 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

#### –¢–µ—Å—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã (Live —Ä–µ–∂–∏–º)
```
–£—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂: 4242 4242 4242 4242
–ù–µ—É–¥–∞—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: 4000 0000 0000 0002
–¢—Ä–µ–±—É–µ—Ç 3D Secure: 4000 0025 0000 3155
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π
1. **Stripe Dashboard** ‚Üí Payments ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–∞–±–ª–∏—Ü—ã `payment_orders` –∏ `transactions`
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å** ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤

### 6. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

#### –õ–æ–≥–∏ Stripe
- **Stripe Dashboard** ‚Üí Developers ‚Üí Logs
- **Webhook Logs** ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏

#### –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- **Vercel Dashboard** ‚Üí Functions ‚Üí Logs
- **Supabase Dashboard** ‚Üí Logs ‚Üí –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ—à–∏–±–∫–∏

### 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ webhook
- –í—Å–µ webhook –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –ø–æ –ø–æ–¥–ø–∏—Å–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ HTTPS endpoints
- –•—Ä–∞–Ω–∏—Ç–µ webhook secret –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ live –∫–ª—é—á–∏ –≤ –∫–æ–¥
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ–ª—å–∫–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- –†–µ–≥—É–ª—è—Ä–Ω–æ —Ä–æ—Ç–∏—Ä—É–π—Ç–µ –∫–ª—é—á–∏

### 8. Troubleshooting

#### Webhook –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ URL webhook
curl -I https://yourdomain.com/api/stripe/webhook

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo $STRIPE_WEBHOOK_SECRET
```

#### Payment Intent –Ω–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ Stripe
curl -u sk_live_...: https://api.stripe.com/v1/payment_intents
```

#### –ö—Ä–µ–¥–∏—Ç—ã –Ω–µ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ webhook –ª–æ–≥–∏ –≤ Stripe
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Vercel
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –≤ Supabase

### 9. –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏
2. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –∫–æ–Ω–≤–µ—Ä—Å–∏—é –ø–ª–∞—Ç–µ–∂–µ–π
3. **–í–æ–∑–≤—Ä–∞—Ç—ã** - –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –æ–±—Ä–∞–±–æ—Ç–∫—É refunds
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –¥–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏

## –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

‚ö†Ô∏è **–í–Ω–∏–º–∞–Ω–∏–µ**: –í live —Ä–µ–∂–∏–º–µ –≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏ —Ä–µ–∞–ª—å–Ω—ã–µ!
- –¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ —Å –Ω–µ–±–æ–ª—å—à–∏–º–∏ —Å—É–º–º–∞–º–∏
- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ webhook —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π

‚úÖ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏**:
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ Stripe
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –æ—à–∏–±–∫–∏
- –í–µ–¥–∏—Ç–µ –ª–æ–≥–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ webhook —Å—Ç–∞—Ç—É—Å
