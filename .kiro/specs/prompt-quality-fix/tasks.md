# Implementation Plan

- [x] 1. Создать инструменты диагностики и сравнения
  - Создать скрипт для сравнения ответов между stable и main ветками
  - Реализовать функцию измерения качества ответов (полнота, язык, токены)
  - Написать тесты для валидации качества промптов
  - _Requirements: 4.1, 4.2, 4.3_

- [x] 2. Исследовать и зафиксировать рабочие промпты из stable ветки
  - Извлечь все промпты из stable ветки как эталонные
  - Создать резервные копии рабочих промптов
  - Документировать структуру и содержание эталонных промптов
  - _Requirements: 3.1, 3.2_

- [ ] 3. Исправить систему загрузки промптов
- [x] 3.1 Рефакторить PromptService для надежной загрузки
  - Переписать функции загрузки промптов с валидацией
  - Добавить fallback механизм к эталонным промптам
  - Реализовать кеширование промптов для стабильности
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 3.2 Создать валидацию промптов
  - Написать функции проверки целостности промптов
  - Добавить проверку соответствия языка промпта
  - Реализовать подсчет токенов для контроля лимитов
  - _Requirements: 4.1, 4.2_

- [ ] 4. Улучшить определение и управление языками
- [x] 4.1 Исправить логику определения языка
  - Переписать функции детекции языка запроса
  - Добавить валидацию консистентности языка
  - Реализовать принудительное соответствие языка промпта и ответа
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 4.2 Создать систему контроля языковой консистентности
  - Написать middleware для проверки языка на всех этапах
  - Добавить логирование языковых переключений
  - Реализовать автоматическое исправление языковых несоответствий
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 5. Оптимизировать API routes для мультиязычности
- [x] 5.1 Рефакторить /api/research route
  - Переписать логику обработки запросов с учетом языка
  - Добавить валидацию входящих данных по языку
  - Реализовать правильную передачу языкового контекста в AI
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [x] 5.2 Рефакторить /api/research-with-credits route
  - Применить те же исправления что и в основном research route
  - Добавить контроль качества ответов перед возвратом
  - Реализовать откат к эталонным промптам при проблемах
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [ ] 5.3 Обновить остальные analysis endpoints
  - Применить исправления ко всем API endpoints анализа
  - Унифицировать обработку языков во всех routes
  - Добавить единообразное логирование и мониторинг
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [ ] 6. Создать систему мониторинга качества
- [ ] 6.1 Реализовать метрики качества ответов
  - Написать функции измерения полноты ответов
  - Добавить отслеживание соответствия языка
  - Создать алерты при снижении качества
  - _Requirements: 1.3, 2.3, 4.1_

- [ ] 6.2 Добавить логирование и диагностику
  - Реализовать детальное логирование процесса анализа
  - Добавить трекинг использования промптов по языкам
  - Создать dashboard для мониторинга качества
  - _Requirements: 4.1, 4.2, 4.3_

- [ ] 7. Создать комплексные тесты
- [ ] 7.1 Написать интеграционные тесты для русского языка
  - Создать тесты полного цикла анализа на русском
  - Проверить качество ответов против эталона из stable
  - Валидировать что ответы полные и на правильном языке
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 7.2 Написать интеграционные тесты для английского языка
  - Создать тесты полного цикла анализа на английском
  - Проверить что английские запросы дают английские ответы
  - Валидировать качество переведенных промптов
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 7.3 Создать тесты переключения языков
  - Написать тесты смены языка в рамках одной сессии
  - Проверить корректность обработки смешанных запросов
  - Валидировать отсутствие влияния предыдущего языка
  - _Requirements: 5.1, 5.2, 5.3_

- [ ] 8. Провести финальную валидацию и оптимизацию
- [ ] 8.1 Сравнить качество с stable веткой
  - Запустить A/B тестирование против stable ветки
  - Измерить метрики качества и производительности
  - Убедиться что качество не хуже эталонного
  - _Requirements: 1.1, 1.2, 2.1, 2.2_

- [ ] 8.2 Оптимизировать производительность
  - Профилировать использование токенов и времени ответа
  - Оптимизировать загрузку и кеширование промптов
  - Минимизировать overhead от мультиязычности
  - _Requirements: 4.1, 4.2_

- [ ] 8.3 Подготовить документацию и мониторинг
  - Создать документацию по исправленной системе
  - Настроить алерты и мониторинг в продакшене
  - Подготовить план rollback в случае проблем
  - _Requirements: 4.3_