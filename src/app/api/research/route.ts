import { NextRequest, NextResponse } from 'next/server'
import { openai, UX_RESEARCH_PROMPT } from '@/lib/openai'

export async function POST(request: NextRequest) {
  try {
    const { url, screenshot } = await request.json()

    if (!url && !screenshot) {
      return NextResponse.json(
        { error: 'URL или скриншот обязательны для анализа' },
        { status: 400 }
      )
    }

    if (url) {
      // Реальный анализ через OpenAI
      const analysisPrompt = `${UX_RESEARCH_PROMPT}\n\nПроанализируй сайт по URL: ${url}\n\nПоскольку я не могу получить скриншот, проведи анализ основываясь на общих принципах UX для данного типа сайта.`
      
      const completion = await openai.chat.completions.create({
        model: "gpt-4o-mini",
        messages: [{ role: "user", content: analysisPrompt }],
        temperature: 0.7,
        max_tokens: 2000,
      })

      const result = completion.choices[0]?.message?.content || 'Не удалось получить анализ'
      return NextResponse.json({ result })
    }

    if (screenshot) {
      // Пока используем mock для скриншотов (нужна доработка для Vision API)
      const mockResult = generateMockResult('загруженный скриншот')
      return NextResponse.json({ result: mockResult })
    }

  } catch (error) {
    console.error('Research API error:', error)
    return NextResponse.json(
      { error: 'Не удалось выполнить анализ. Попробуйте позже.' },
      { status: 500 }
    )
  }
}

function generateMockResult(source: string): string {
  return `# Результат UX исследования

## 1. Описание экрана

Проанализирован интерфейс: ${source}

Основные элементы включают:
- Навигационную панель в верхней части
- Основной контентный блок 
- Боковые элементы управления
- Футер с дополнительной информацией

Общая структура соответствует современным принципам веб-дизайна.

## 2. UX-опрос

1. **Понятно ли пользователю основное предназначение интерфейса?**
   - Требует дополнительного анализа целевой аудитории

2. **Легко ли найти ключевые функции?**
   - Основные элементы находятся в ожидаемых местах

3. **Соответствует ли дизайн ожиданиям пользователей?**
   - Использует знакомые паттерны взаимодействия

4. **Удобна ли навигация по интерфейсу?**
   - Структура навигации требует оптимизации

5. **Есть ли четкая визуальная иерархия?**
   - Иерархия присутствует, но может быть улучшена

## 3. Проблемы и рекомендации

### Проблема 1: Контрастность текста
**Описание**: Некоторые текстовые элементы имеют недостаточный контраст
**Влияние**: Затрудняет чтение для пользователей с нарушениями зрения
**Рекомендация**: Увеличить контраст до соответствия WCAG 2.1 (минимум 4.5:1)

### Проблема 2: Размер кликабельных элементов
**Описание**: Некоторые кнопки и ссылки меньше рекомендуемого размера
**Влияние**: Снижает удобство использования на мобильных устройствах
**Рекомендация**: Увеличить минимальный размер до 44x44px

### Проблема 3: Загрузка контента
**Описание**: Отсутствуют индикаторы загрузки для долгих операций
**Влияние**: Пользователи не понимают, что система обрабатывает запрос
**Рекомендация**: Добавить skeleton loading или прогресс-бары

## 4. Self-check

**Уверенность анализа**: 75%

**Ограничения**:
- Анализ проведен без прямого взаимодействия с интерфейсом
- Отсутствуют данные о реальном поведении пользователей
- Не учтены специфические требования бизнеса
- Требуется дополнительное тестирование на различных устройствах

**Рекомендации по улучшению анализа**:
- Провести юзабилити-тестирование с реальными пользователями
- Собрать аналитические данные о поведении на сайте
- Изучить отзывы и комментарии пользователей`
}
